---
title: "DATS6101 Project 1"
author: "Mihir Gadgil, Elie Tetteh-Wayoe, Jessica Fogerty, Aluya Omofuma, Pierre Bamba"
date: "October 1, 2018"
output: html_document
---
```{r setup, include = F}
library(ggplot2)
library(dplyr)
```

#### EDA
Loading the dataset and reviewing its structure
```{r load_data, echo = F}
#Load the dataset
athletes <- read.csv("athlete_events.csv", na.strings = c("NA"))
#Explore the structure of the dataset
str(athletes)
```

Some columns need to be edited. Medal as ordered factor, dropping Age, Height, Weight, City and Games. Select only the Summer Olympics data.
```{r cleanup_1, echo = F}
#athletes$Year <- as.integer(athletes$Year)
athletes$Medal <- factor(athletes$Medal, levels = c("Bronze", "Silver", "Gold"), ordered = TRUE)
athletes$NOC <- as.character(athletes$NOC)
#athletes$Gender <- as.factor(athletes$Gender)
athletes <- subset(athletes, select = -c(Age, Height, Weight, City, Games))
athletes <- subset(athletes, Season == "Summer")
```

Insert host country data into the data frame. Change some country codes to simplify analysis.
```{r cleanup_2, echo = F}
hosts <- data.frame(Year = c(seq(1896, 1912, 4), seq(1920, 1936, 4), seq(1948, 2016, 4)), Host_NOC = c("GRE", "FRA", "USA", "GBR", "SWE", "BEL", "FRA", "NED", "USA", "GER", "GBR", "FIN", "AUS", "ITA", "JPN", "MEX", "GER", "CAN", "RUS", "USA", "KOR", "ESP", "USA", "AUS", "GRE", "CHN", "GBR", "BRA"))
athletes <- merge(athletes, hosts, by.x = "Year", by.y = "Year")
athletes$Host_NOC[athletes$Year == 1956 & athletes$City == "Stockholm"] <- "SWE"
athletes$Host_NOC <- as.character(athletes$Host_NOC)
athletes$NOC[athletes$NOC == "URS"] <- "RUS"
athletes$NOC[athletes$NOC == "FRG"] <- "GER"
athletes$NOC[athletes$NOC == "GDR"] <- "GER"
athletes$NOC[athletes$NOC == "ANZ"] <- "AUS"
#Equating China and Hong Kong would help too, but it seems like they have been participating as different teams since 1952.
```
Interesting fact: 1906 had Olympic games, too. They were officially recognized as such at that time, but aren't considered Olympic games now.

Summary of the dataset
```{r after_cleanup, echo = F}
summary(athletes)
```

#### Analysis
Take a look at the number of events conducted through years. Men/Women events counted separately.

```{r unique_events, echo = F}
unique_events_by_year <- data.frame(summarize(group_by(count(group_by(athletes, Year, Event)), Year), Events = n()))
unique_events_by_year.plot <- ggplot(data = unique_events_by_year) + geom_line(aes(x = Year, y = Events)) + ylab("Number of Events") + labs(title = "Number of Events at each Olympic")
unique_events_by_year.plot
```

Athlete participation over years.

```{r unique_participants, echo = F}
participation <- data.frame(summarize(group_by(count(group_by(athletes, Year, ID)), Year), Participants = n()))
participation.plot <- ggplot(data = participation) + geom_line(aes(x = Year, y = Participants)) + labs(y = "Unique Athletes", title = "Unique Athletes at each Olympic")
participation.plot
```

Number of women's events and women's participation is catching upto men's participation.
```{r gender_participation, echo = F}
gender_participation <- data.frame(summarize(group_by(count(group_by(athletes, Year, Sex, ID)), Year, Sex), Participants = n()))
gender_participation <- add_row(gender_participation, Year = 1896, Sex = "F", Participants = 0, .before = 1)
gender_participation.plot <- ggplot(data = gender_participation) + geom_line(aes(x = Year, y = Participants, color = Sex)) + labs(title = "Number of Men and Women Participants over the years")
gender_participation.plot
```

In fact the previous graph doesn't do the situation justice.
```{r women_participation, echo = F}
#Difference in medal count for men and women
women_participation <- data.frame(Year = hosts$Year, Proportion = gender_participation$Participants[gender_participation$Sex == "F"] / participation$Participants * 100)
women_participation.plot <- ggplot(data = women_participation) + geom_line(aes(x = Year, y = Proportion)) + labs(y = "Percent of Total Participation", title = "Women's Participation in Olympics over the years")
women_participation.plot
```

Linear model isn't actually the best fir here, since we expect the proportion to increase and then settle near 50%.  
The linear model is:  
Proportion = Intercept + Slope $\times$ Year
```{r linear_model1, echo = F}
#Create linear model for difference in medal count VS year
proportion_model <- lm(I(Proportion - 0) ~ I(Year - 1896) + 0, data = women_participation)
slope <- proportion_model$coefficients
cat("Slope:", slope)
```

```{r linear_model2, echo = F}
prop_func <- function(year) {
  slope * (year - 1896)
}

women_participation.plot2 <- ggplot(data = women_participation, aes(x = Year)) + stat_function(fun = prop_func) + labs(y = "Percent of Total Participation", title = "Women's Participation in Olympics over the years") + geom_point(aes(x = Year, y = Proportion))
women_participation.plot2

cat("Predicted 50% year:", round(50 / slope + 1896))
```

Cold war's effect on USA and Russia's performance

```{r cold_war, echo = F}
#Select data from cold war years and only for USA and Russia
cold_war <- subset(athletes, Year >= 1947 & Year <= 1991 & (NOC == "USA" | NOC == "RUS"))
cold_war_participation <- data.frame(summarize(group_by(count(group_by(cold_war, Year, NOC, ID)), Year, NOC), Participants = n()))

cold_war_participation.plot <- ggplot(data = cold_war_participation) + geom_line(aes(x = Year, y = Participants, color = NOC)) + labs(title = "USA and Russia's participation during Cold War")
cold_war_participation.plot
```

Russia outperformed USA, in terms of medals won, in almost every Olympic during the Cold War.  
USA did not participate in the Olympics in 1980 and Russia did the same in 1948 and 1984.

```{r cold_war2, echo = F}
russia_participation <- sum(subset(cold_war_participation, NOC == "RUS")$Participants)
usa_participation <- sum(subset(cold_war_participation, NOC == "USA")$Participants)
cat("Number of participants by Russia", russia_participation, end = "\n")
cat("Number of participants by USA", usa_participation)
```

```{r cold_war3, echo = F}
cold_war_performance <- summarize(group_by(subset(cold_war, !is.na(Medal)), Year, NOC), Winners = n())
cold_war_performance.plot <- ggplot(data = cold_war_performance) + geom_line(aes(x = Year, y = Winners, color = NOC)) + labs(y = "Number of Medals", title = "USA and Russia's Performance during the Cold War")
cold_war_performance.plot
```

```{r cold_war4, echo = F}
russia_winners <- sum(subset(cold_war_performance, NOC == "RUS")$Winners)
usa_winners <- sum(subset(cold_war_performance, NOC == "USA")$Winners)
cat("Number of medals for Russia:", russia_winners, end = "\n")
cat("Number of medals for USA:", usa_winners)
```

```{r echo = F}
winners_only <- subset(athletes, !is.na(Medal))
```

```{r all_medals, echo = F}
country_medals <- summarize(group_by(winners_only, Year, NOC), Medal_Count = n())
# country_medals <- merge(country_medals, total_medals, by.x = "Year", by.y = "Year")
# names(country_medals) <- c("Year", "NOC", "Medal_Count", "Total_Medals")
# country_medals$Proportion <- country_medals$Medal_Count / country_medals$Total_Medals
country_medals.plot <- ggplot(data = country_medals) + geom_point(aes(x = Year, y = Medal_Count, color = NOC), show.legend = F) + labs(y = "Number of Medals", title = "Medals Earned by Countries over Years")
country_medals.plot
```

Top 5 medal winners over all Olympics
```{r top_winners, echo = F}
country_medals.total <- country_medals %>% group_by(NOC) %>% summarize(Medal_Count = sum(Medal_Count))
country_medals.total <- data.frame(country_medals.total[order(country_medals.total$Medal_Count, decreasing = T),])
print(country_medals.total[1:5,])
```

Maximum medals earned by Sport
```{r sport_winners, echo = F}
country_medals.sport <- winners_only %>% group_by(NOC, Sport) %>% summarize(Medal_Count = n())

country_medals.sport <- country_medals.sport %>% group_by(Sport) %>% filter(Medal_Count == max(Medal_Count))
country_medals.sport <- country_medals.sport[order(country_medals.sport$Medal_Count, decreasing = T),]
print(country_medals.sport)
```

#### Does the Host Country have an advantage in Olympics?
```{r host_advantage, echo = F}
total_medals <- winners_only %>% group_by(Year) %>% summarize(Medal_Count = n())

hosts_only <- subset(winners_only, NOC %in% hosts$Host_NOC)

medals_when_host <- subset(hosts_only, NOC == Host_NOC) %>% group_by(Year, NOC) %>% summarize(Medal_Count = n())
host_medal_proportion <- data.frame(NOC = medals_when_host$NOC, Proportion = medals_when_host$Medal_Count / total_medals$Medal_Count)
host_medal_proportion <- host_medal_proportion %>% group_by(NOC) %>% summarize(Avg_Proportion = mean(Proportion))

medals_when_not_host <- subset(hosts_only, NOC != Host_NOC) %>% group_by(Year, NOC) %>% summarize(Medal_Count = n())
nonhost_medal_proportion <- merge(medals_when_not_host, total_medals, by.x = "Year", by.y = "Year")
nonhost_medal_proportion$Proportion <- nonhost_medal_proportion$Medal_Count.x / nonhost_medal_proportion$Medal_Count.y
nonhost_medal_proportion <- nonhost_medal_proportion %>% group_by(NOC) %>% summarize(Avg_Proportion = mean(Proportion))
```

Based on the visual inspection we would like to conduct a hypothesis test with the following hypothesis:  
$\mu_{D}$ is the difference between the average proportion of medals won as a host country and as a non host country  
$H_{0}: \mu_{D} = 0$  
$H_{1}: \mu_{D} > 0$  
Conduct a right tailed t-test to check whether a host country gets any advantage or not. Significance level $\alpha = 0.05$
```{r host_advantage2, echo = F}
host_advantage_test <- t.test(host_medal_proportion$Avg_Proportion, nonhost_medal_proportion$Avg_Proportion, paired = T, conf.level = 0.95, alternative = "greater")
host_advantage_test
```
The p-value $`r host_advantage_test$p.value`$ is smaller than the significance level $0.05$.  
$\therefore$ We reject the null hypothesis.
